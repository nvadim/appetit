function masking(){$('.client-preview input[name="PHONE"], input[name="USER_PHONE"]').mask(window.phone_mask,{}),$('.client-preview input[name="BIRTHDAY"]').mask("99.99.9999",{})}function renderOrderLine(e){var t="sms-decline-popover",i="send-mail-disable";1==e.SEND_SMS&&(t="sms-accept-popover",i="send-mail-active"),$(".orders-list").prepend('<div class="orders-line order-status-'+e.STATUS+'" data-order="'+e.ID+'" data-username="'+e.USER_NAME+'" data-phone="'+e.USER_PHONE+'" data-sum="'+e.ORDER_SUM+'" data-address="пїЅпїЅ. '+e.STREET+", пїЅ."+e.HOUSE+", пїЅпїЅ. "+e.APARTMENT+'" data-order-date="'+e.ORDER_DATE_F+'" data-status="пїЅпїЅпїЅпїЅпїЅ"> <div onclick="viewUser('+e.USER_ID+')" class="orders-line__num "><span></span><a href="#client-1">1</a></div><div data-id="'+t+'" data-placement="left" data-handler="popover" class="orders-line__send-mail '+i+'"><span></span></div> <div class="orders-line__show-card " onclick="viewOrder('+e.ID+');">пїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅ</div> <div class="orders-line__info"> <div class="orders-line__status orders-line__status--'+e.STATUS+'">пїЅпїЅпїЅпїЅпїЅ</div><div class="orders-line__about-out"><div class="orders-line__about"> <div class="orders-line__date"> <div class="title">пїЅпїЅпїЅпїЅ</div> <p>'+e.ORDER_DATE_F+'</p> </div> <div class="orders-line__name"> <div class="title">пїЅпїЅпїЅ</div> <p>'+e.USER_NAME+'</p> </div> <div class="orders-line__phone"><div class="title">пїЅпїЅпїЅпїЅпїЅпїЅпїЅ</div> <p>'+e.USER_PHONE+'</p> </div> <div class="orders-line__summa"> <div class="title">пїЅпїЅпїЅпїЅпїЅ</div> <p><span>'+number_format(e.ORDER_SUM,0,"."," ")+'</span><span class="currency">R</span></p></div> </div> </div> </div></div>')}function getCatSelectHtml(e){var t="";for(var i in window.product_categories){var s="";i==e&&(s='selected="selected"'),t+="<option "+s+' value="'+i+'">'+window.product_categories[i].name+"</option>"}return t}function getProductsForSection(e,t){var i="";for(var s in window.product_categories[e].products){var a="";s==t&&(a='selected="selected"'),i+='<option data-price="'+window.product_categories[e].products[s].price+'" '+a+' value="'+s+'">'+window.product_categories[e].products[s].name+"</option>"}return i}function createProduct(){var e=parseInt($(".order-preview .order-list__line").last().attr("data-index"))+1,t='<div class="product_config_cont"><input type="hidden" name="BASKET_CONTENT['+e+'][PRODUCT_ID]" value="0" /><input type="hidden" name="BASKET_CONTENT['+e+'][ID]" class="item_id" value="0" /></div><div data-index="'+e+'"  data-price="0" class="order-list__line row"><div class="edit-cont" style="display: block;"><div class="order-list__categor"><select class="basic product_categories_" >'+getCatSelectHtml(Object.keys(window.product_categories)[0])+"</select></div>";t+='<div class="order-list__product index-'+e+'"><div class="order-list__product-select"><select class="basic products_">'+getProductsForSection(Object.keys(window.product_categories)[0],null)+"</select></div></div></div>",t+='<div class="order-list__kvo"> <div class="colich_tov"> <input type="button" value="-" class="minus_tov" /> <input type="text" name="BASKET_CONTENT['+e+'][AMOUNT]" value="1" class="txt_col_tov" /> <input type="button" value="+" class="plus_tov" /> </div> </div><div class="order-list__price"><span>0</span> <span class="currency">'+window.currency_f+'</span></div><div class="order-list__edit"></div><div class="order-list__delete"></div>',t+="</div>",$(".order-list__content").append(t),$('.order-list__content .order-list__line[data-index="'+e+'"] select').selectOrDie(),registerOrderProductItemListeners(),$('.order-list__content .order-list__line[data-index="'+e+'"] select').last().trigger("change")}function getProductOptions(e,t,i,s){var a='<div class="row">';for(var n in i)if(window.product_categories[e].products[t].options[n]){a+='<div class="order-list__properties"><select data-placeholder-option="true" name="BASKET_CONTENT['+s+"][OPTIONS][OPTION_"+n+']" class="basic prod_option option_'+n+'">';var d="";a+='<option value="null">'+window.product_categories[e].products[t].options[n][0].PROP+"</option>";for(var r in window.product_categories[e].products[t].options[n])parseInt(i[n])==parseInt(window.product_categories[e].products[t].options[n][r].INDEX)&&(d='selected="selected"'),a+="<option "+d+' value="'+r+'" data-price="'+window.product_categories[e].products[t].options[n][r].PRICE+'" data-old-price="'+window.product_categories[e].products[t].options[n][r].OLD_PRICE+'" data-weight="'+window.product_categories[e].products[t].options[n][r].WEIGHT+'">'+window.product_categories[e].products[t].options[n][r].VALUE+"</option>";a+="</select></div>"}return a+="</div>"}function viewOrder(e){return void 0!==window.new_orders&&window.new_orders>0&&window.new_orders--,$(".wrapper").first().css("opacity",0),$(".order-preview .spinner").show(),$(".order-preview .wrap").css("opacity",0),$(".order-preview").css("opacity","1"),$(".order-preview").css("position","absolute"),$(".client-preview").is(":visible")&&($(".order-preview").css("z-index",3),$(".client-preview").css("z-index",2),$(".client-preview").css("opacity","0"),$(".client-preview").css("position","fixed")),window.location.hash="#order-"+e,$(".order-list__content").html(""),$.ajax({url:"/crm/",method:"POST",dataType:"json",data:{action:"getOrder",id:e},success:function(t){$(".payment-status").hide(),$(".print-bt").attr("href","/crm/print.php?id="+e),2==t.DELIVERY_TYPE?$(".delivery-select__item.himself").trigger("click"):$(".delivery-select__item.courier").trigger("click"),$('[name="DELIVERY_TIME_TYPE"]').val(t.DELIVERY_TIME_TYPE),0==t.DELIVERY_TIME_TYPE?($(".time_config").hide(),$(".time_type_toggle").show()):($(".time_type_toggle").hide(),$('[name="DELIVERY_TIME"]').val(t.DELIVERY_TIME).parent().addClass("filled"),$('[name="DELIVERY_TIME"]').val(t.DELIVERY_TIME).parent().addClass("filled"),$('[name="DELIVERY_DATE"]').find('option[data-valued="'+t.DELIVERY_DATE+'"]').attr("selected","selected").parent().selectOrDie("update"),$(".time_config").show()),$(".customer-information__status").attr("class","customer-information__status").addClass("customer-information__status--"+t.STATUS),0!=t.USER_ID?$(".customer-information__client-head .num a").attr("href","#client-"+t.USER_ID).attr("onclick","viewUser("+t.USER_ID+")").text(t.USER_ID).parent().show():$(".customer-information__client-head .num").hide(),$(".order_num_value").text(t.ID),$('[name="ID"]').val(t.ID),$('[name="USER_ID"]').val(t.USER_ID),$('[name="ORDER_SUM"]').val(t.ORDER_SUM),$('[name="DELIVERY_PRICE"]').val(t.DELIVERY_PRICE),$(".customer-information__status").text(t.STATUS_NAME),$(".source-order span").text(t.SOURCE),$('[name="STATUS"]').val(t.STATUS).selectOrDie("update");var i=t.ORDER_SUM-t.DELIVERY_PRICE-t.DISCOUNT_BONUSES;i<0&&(i=0),$(".order_sum_value span").first().text(i),$(".delivery_price_value span").first().text(t.DELIVERY_PRICE),$(".promo_code_discount_value span").first().text(t.DISCOUNT+"%"),t.DISCOUNT_BONUSES>0?($(".bonuses_used_value").show(),$(".bonuses_used_value span").first().text(t.DISCOUNT_BONUSES)):$(".bonuses_used_value").hide(),$(".itogo span").first().text(t.ORDER_SUM),$('[name="DELIVERY_TYPE"]').val(t.DELIVERY_TYPE),$('[name="USER_NAME"]').val(t.USER_NAME).parent().addClass("filled"),$('[name="USER_PHONE"]').val(t.USER_PHONE).parent().addClass("filled"),$('select[name="PAYMENT_TYPE"]').val(t.PAYMENT_TYPE).trigger("change").selectOrDie("update"),void 0!=t.DISTRICT_ID&&null!=t.DISTRICT_ID&&$('select[name="DISTRICT_ID"]').val(t.DISTRICT_ID).selectOrDie("update"),void 0!=t.DELIVERY_PICKUP_ID&&null!=t.DELIVERY_PICKUP_ID&&$('select[name="DELIVERY_PICKUP_ID"]').val(t.DELIVERY_PICKUP_ID).selectOrDie("update"),null!=t.ONLINE_PAY_SIGNATURE?1==t.ONLINE_PAY_STATUS?$(".payment-status.paid").show():$(".payment-status.not-paid").show():$(".payment-status").hide(),$('[name="DISCOUNT"]').val(0),$('[name="DISCOUNT_BONUSES"]').val(0),0!==t.DISCOUNT&&$('[name="DISCOUNT"]').val(t.DISCOUNT),0!==t.DISCOUNT_BONUSES&&$('[name="DISCOUNT_BONUSES"]').val(t.DISCOUNT_BONUSES),$(".pickup_discount").hide(),0!=t.DISCOUNT_PICKUP&&($(".pickup_discount span").first().text(t.DISCOUNT_PICKUP).parent().parent().show(),$('[name="DISCOUNT"]').val(t.DISCOUNT_PICKUP)),$('[name="STREET"]').val(t.STREET).parent().addClass("filled"),$('[name="HOUSE"]').val(t.HOUSE).parent().addClass("filled"),$('[name="APARTMENT"]').val(t.APARTMENT).parent().addClass("filled"),void 0!=t.COMMENT&&null!=t.COMMENT&&t.COMMENT.length>0&&$('[name="COMMENT"]').val(t.COMMENT).parent().addClass("filled"),void 0!=t.ODD_MONEY&&null!=t.ODD_MONEY&&t.ODD_MONEY>0&&$('[name="ODD_MONEY"]').val(t.ODD_MONEY).parent().addClass("filled"),void 0!=t.PROMO_CODE&&null!=t.PROMO_CODE&&t.PROMO_CODE.length>0?($(".promo_code_discount_value").show(),$(".customer-information__promokod").show(),$('[name="PROMO_CODE"]').val(t.PROMO_CODE).parent().addClass("filled").show()):($(".promo_code_discount_value").hide(),$(".customer-information__promokod").hide(),$('[name="PROMO_CODE"]').val("").parent().hide()),$.each(t.BASKET_CONTENT.products,function(e,t){if(void 0!=t.ID){var i=t.ID,s="",a="",n='<div class="product_config_cont"><input type="hidden" name="BASKET_CONTENT['+e+'][PRODUCT_ID]" value="'+t.ID+'" /><input type="hidden" name="BASKET_CONTENT['+e+'][ID]" class="item_id" value="'+t.ID+'" />';if(t.ID.indexOf("additional")!==-1&&(n+='<input type="hidden" name="BASKET_CONTENT['+e+'][TYPE]" value="additional"><input type="hidden" name="BASKET_CONTENT['+e+'][IS_ADDITIONAL]" value="1" /><input type="hidden" name="BASKET_CONTENT['+e+'][ADDITIONAL_ID]" value="'+t.ID.split("_")[1]+'" />'),t.ID.indexOf("gift")!==-1&&(n+='<input type="hidden" name="BASKET_CONTENT['+e+'][TYPE]" value="gift"><input type="hidden" name="BASKET_CONTENT['+e+'][IS_GIFT]" value="1" /><input type="hidden" name="BASKET_CONTENT['+e+'][GIFT_ID]" value="'+t.GIFT_ID+'" />'),t.ID.indexOf("promo")!==-1&&(n+='<input type="hidden" name="BASKET_CONTENT['+e+'][TYPE]" value="promo"><input type="hidden" name="BASKET_CONTENT['+e+'][IS_PROMO]" value="1" /><input type="hidden" name="BASKET_CONTENT['+e+'][PROMO_ID]" value="'+t.PRODUCT_ID+'" />'),t.ID.indexOf("constructor")!==-1&&(n+='<input type="hidden" name="BASKET_CONTENT['+e+'][IS_CONSTRUCTOR]" value="1" /><input type="hidden" name="BASKET_CONTENT['+e+'][ID]" value="constructor" /><input type="hidden" name="BASKET_CONTENT['+e+'][PRODUCT_ID]" value="constructor" /><input type="hidden" name="BASKET_CONTENT['+e+'][NAME]" value="'+t.NAME+'" /><input type="hidden" name="BASKET_CONTENT['+e+'][PRICE]" value="'+t.PRICE+'" /><input type="hidden" name="BASKET_CONTENT['+e+'][WEIGHT]" value="'+t.WEIGHT+'" /><input type="hidden" name="BASKET_CONTENT['+e+'][IMAGE]" value="'+t.IMAGE+'" /><input type="hidden" name="BASKET_CONTENT['+e+'][BASE_ID]" value="'+t.BASE_ID+'" /><input type="hidden" name="BASKET_CONTENT['+e+'][SOUSE_ID]" value="'+t.SOUSE_ID+'" />',$.each(t.INGREDIENTS,function(t,i){n+='<input type="hidden" name="BASKET_CONTENT['+e+'][INGREDIENTS][]" value="'+i+'" />'}),$.each(t.ING_AMOUNT,function(t,i){n+='<input type="hidden" name="BASKET_CONTENT['+e+'][ING_AMOUNT][]" value="'+i+'" />'})),n+="</div>",void 0!==t.OPTIONS&&null!==t.OPTIONS[1]&&void 0!=window.product_categories[t.SECTION_ID].products[i]&&void 0!==window.product_categories[t.SECTION_ID].products[i].options[1][t.OPTIONS[1]]){var d={};a+='<div class="options_view"><div class="option-el option_1"><div class="op_name">'+window.product_categories[t.SECTION_ID].products[i].options[1][0].PROP+'</div><div class="op_value">'+window.product_categories[t.SECTION_ID].products[i].options[1][t.OPTIONS[1]].VALUE+"</div></div>",d[1]=t.OPTIONS[1],null!==t.OPTIONS[2]&&void 0!==window.product_categories[t.SECTION_ID].products[i].options[2][0]&&(d[2]=t.OPTIONS[2],a+='<div class="option-el option_2"><div class="op_name">'+window.product_categories[t.SECTION_ID].products[i].options[2][0].PROP+'</div><div class="op_value">'+window.product_categories[t.SECTION_ID].products[i].options[2][t.OPTIONS[2]].VALUE+"</div></div>"),a+="</div>",s=getProductOptions(t.SECTION_ID,i,d,e)}t.ID.indexOf("additional_")==-1&&t.ID.indexOf("gift_")==-1||(i=t.ID.split("_")[1]),void 0!==t.IS_CONSTRUCTOR&&(a+='<div class="options_view"><div class="option-el option_1"><div class="op_name">пїЅпїЅпїЅпїЅпїЅпїЅ</div><div class="op_value">'+t.BASE_NAME+'</div><div class="op_name op_name_2">пїЅпїЅпїЅпїЅ</div><div class="op_value">'+t.SOUSE_NAME+"</div></div>",a+='<div class="option-el option_2"><div class="op_name">пїЅпїЅпїЅпїЅпїЅпїЅпїЅ</div>',$.each(t.INGREDIENTS_NAME,function(e,t){a+='<div class="op_value">'+t+"</div>"}),a+="</div>");var r=n+'<div data-index="'+e+'"  data-price="'+t.PRICE+'" class="order-list__line row '+t.CLASSES+" prod_"+t.ID+'"><div class="view-cont_"><div class="product-image"><img src="'+t.IMAGE+'"></div><div class="name-cont"><div class="name">'+t.NAME+'</div><div class="section">'+t.SECTION+"</div>"+a+"</div></div>";if(void 0==t.IS_CONSTRUCTOR&&"promo"!==t.ID){var o="";void 0==t.IS_ADDITIONAL&&(o=' name="BASKET_CONTENT['+e+'][SECTION_ID]" '),r+='<div class="edit-cont" style="display: none;"><div class="order-list__categor"><select '+o+' class="basic product_categories_" >'+getCatSelectHtml(t.SECTION_ID)+"</select></div>",r+='<div class="order-list__product index-'+t.INDEX+'"><div class="order-list__product-select"><select class="basic products_">'+getProductsForSection(t.SECTION_ID,i)+"</select>"+s+"</div></div></div>"}r+='<div class="order-list__kvo"> <div class="colich_tov"> <input type="button" value="-" class="minus_tov" /> <input type="text" name="BASKET_CONTENT['+e+'][AMOUNT]" value="'+t.AMOUNT+'" class="txt_col_tov" /> <input type="button" value="+" class="plus_tov" /> </div> </div><div class="order-list__price"><span>'+t.LOCAL_SUM+'</span> <span class="currency">'+window.currency_f+'</span></div><div class="order-list__edit"></div><div class="order-list__delete"></div>',r+="</div>",$(".order-list__content").append(r),void 0!==t.OPTIONS&&null!==t.OPTIONS[1]&&($(".order-preview .prod_"+t.ID).find(".option_1").val(t.OPTIONS[1]),null!==t.OPTIONS[2]&&$(".order-preview .prod_"+t.ID).find(".option_2").val(t.OPTIONS[2])),$(".order-list__content select").selectOrDie()}}),masking(),registerOrderProductItemListeners(),calculateOrderSum(),$(".order-preview .spinner").hide(),$(".order-preview .wrap").css("opacity",1)}}),$(".order-preview").show(),!1}function registerOrderProductItemListeners(){$(".order-list__line .prod_option").off().on("change",function(){var e=$(this).closest(".order-list__line"),t=1;2==e.find(".prod_option").length&&(t=2);var i,s,a;i=parseInt(e.find(".prod_option").first().find("option:selected").data("price")),s=parseInt(e.find(".prod_option").first().find("option:selected").data("old-price")),a=parseInt(e.find(".prod_option").first().find("option:selected").data("weight")),2==t&&(i+=parseInt(e.find(".prod_option").last().find("option:selected").data("price")),isNaN(parseInt(e.find(".prod_option").last().find("option:selected").data("old-price")))||(s+=parseInt(e.find(".prod_option").last().find("option:selected").data("old-price"))),a+=parseInt(e.find(".prod_option").last().find("option:selected").data("weight"))),isNaN(i)||e.attr("data-price",i);var n=number_format(e.find(".txt_col_tov").val()*i,0,"."," ");0!=n&&$(this).closest(".order-list__line").find(".order-list__price span").first().text(n),calculateOrderSum(),e.find(".prod_option").selectOrDie("update")}),$(".order-list__line .products_").off().on("change",function(){$(this).closest(".order-list__line").attr("data-price",$(this).find("option:selected").data("price"));var e=0;$(this).closest(".order-list__line").prev().find(".additional_id_input").length&&($(this).closest(".order-list__line").prev().find('[name="BASKET_CONTENT['+$(this).closest(".order-list__line").attr("data-index")+'][PRODUCT_ID]"]').val("additional_"+$(this).val()),$(this).closest(".order-list__line").prev().find('[name="BASKET_CONTENT['+$(this).closest(".order-list__line").attr("data-index")+'][ID]"]').val("additional_"+$(this).val()),$(this).closest(".order-list__line").prev().find(".additional_id_input").val($(this).val()),e=1),$(this).closest(".order-list__line").prev().find(".gift_id_input").length&&($(this).closest(".order-list__line").prev().find('[name="BASKET_CONTENT['+$(this).closest(".order-list__line").attr("data-index")+'][PRODUCT_ID]"]').val("gift"),$(this).closest(".order-list__line").prev().find('[name="BASKET_CONTENT['+$(this).closest(".order-list__line").attr("data-index")+'][ID]"]').val("gift"),$(this).closest(".order-list__line").prev().find(".gift_id_input").val($(this).val()),e=1),$(this).closest(".order-list__line").find(".order-list__price span").first().text(number_format(parseInt($(this).find("option:selected").data("price"))*parseInt($(this).closest(".order-list__line").find(".txt_col_tov").val()),0,"."," ")),0==e&&($(this).closest(".order-list__line").prev().find('[name="BASKET_CONTENT['+$(this).closest(".order-list__line").attr("data-index")+'][PRODUCT_ID]"]').val($(this).val()),$(this).closest(".order-list__line").prev().find('[name="BASKET_CONTENT['+$(this).closest(".order-list__line").attr("data-index")+'][ID]"]').val($(this).val())),calculateOrderSum();var t=getProductOptions($(this).closest(".order-list__line").find(".product_categories_").val(),$(this).val(),{1:null,2:null},$(this).closest(".order-list__line").attr("data-index"));t&&($(this).closest(".order-list__line").find(".order-list__product-select .row").remove(),$(this).closest(".order-list__line").find(".edit-cont .order-list__product-select").append(t),$(this).closest(".order-list__line").find(".edit-cont").find("select").selectOrDie(),registerOrderProductItemListeners()),$(this).closest(".order-list__line").find(".edit-cont").find("select").selectOrDie("update")}),$(".order-list__delete").off().on("click",function(e){$(this).closest(".order-list__line").prev().remove(),$(this).closest(".order-list__line").remove(),calculateOrderSum()}),$(".order-list__edit").off().on("click",function(e){$(this).closest(".order-list__line").find(".view-cont_").hide(),$(this).closest(".order-list__line").find(".edit-cont").show()}),$(".minus_tov").off().on("click",function(e){var t=$(this).next(".txt_col_tov"),i=t.val();i>1&&(i--,t.val(i));var s=number_format(i*parseInt($(this).closest(".order-list__line").attr("data-price")),0,"."," ");$(this).closest(".order-list__line").find(".order-list__price span").first().text(s),calculateOrderSum(),e.preventDefault()}),$(".plus_tov").off().on("click",function(e){var t=$(this).prev(".txt_col_tov"),i=t.val();i++,t.val(i);var s=number_format(i*parseInt($(this).closest(".order-list__line").attr("data-price")),0,"."," ");$(this).closest(".order-list__line").find(".order-list__price span").first().text(s),calculateOrderSum(),e.preventDefault()}),$(".product_categories_").off().on("change",function(){$(this).closest(".order-list__line").find(".products_").html(getProductsForSection($(this).val(),0)).selectOrDie("update"),"additional"==$(this).val()?($(this).closest(".order-list__line").prev().append('<input type="hidden" name="BASKET_CONTENT['+$(this).closest(".order-list__line").attr("data-index")+'][IS_ADDITIONAL]" value="1"  class="additional_id_input_h">'),$(this).closest(".order-list__line").prev().append('<input type="hidden" name="BASKET_CONTENT['+$(this).closest(".order-list__line").attr("data-index")+'][ADDITIONAL_ID]" value="" class="additional_id_input">'),$(this).closest(".order-list__line").prev().append('<input type="hidden" name="BASKET_CONTENT['+$(this).closest(".order-list__line").attr("data-index")+'][TYPE]" value="additional" class="additional_id_input_type">')):($(this).closest(".order-list__line").prev().find(".additional_id_input").remove(),$(this).closest(".order-list__line").prev().find(".additional_id_input_h").remove(),$(this).closest(".order-list__line").prev().find(".additional_id_input_type").remove()),"gifts"==$(this).val()?($(this).closest(".order-list__line").prev().append('<input type="hidden" name="BASKET_CONTENT['+$(this).closest(".order-list__line").attr("data-index")+'][IS_GIFT]" value="1"  class="gift_id_input_h">'),$(this).closest(".order-list__line").prev().append('<input type="hidden" name="BASKET_CONTENT['+$(this).closest(".order-list__line").attr("data-index")+'][GIFT_ID]" value="" class="gift_id_input">'),$(this).closest(".order-list__line").prev().append('<input type="hidden" name="BASKET_CONTENT['+$(this).closest(".order-list__line").attr("data-index")+'][TYPE]" value="gift" class="gift_id_input_type">')):($(this).closest(".order-list__line").prev().find(".gift_id_input").remove(),$(this).closest(".order-list__line").prev().find(".gift_id_input_h").remove(),$(this).closest(".order-list__line").prev().find(".gift_id_input_type").remove()),$(this).selectOrDie("update"),$(this).closest(".order-list__line").find(".products_").trigger("change")})}function calculateOrderSum(){var e=0;$(".order-preview .order-list__line").each(function(t,i){e+=$(i).attr("data-price")*parseInt($(i).find(".txt_col_tov").val())});var t=$('[name="DISTRICT_ID"] option:selected').data("price");e>=parseInt($('[name="DISTRICT_ID"] option:selected').data("free"))&&(t=0),$('[name="ORDER_SUM"]').val(e),$('[name="DELIVERY_PRICE"]').val(t),$(".order_sum_value span").first().text(number_format(e,0,"."," ")),$(".delivery_price_value span").first().text(number_format(t,0,"."," ")),$(".itogo span").first().text(number_format(e+t-e*parseInt($('[name="DISCOUNT"]').val())/100-parseInt($('[name="DISCOUNT_BONUSES"]').val()),0,"."," "))}function viewUser(e){return $(".wrapper").first().css("opacity",0),$(".client-preview").show(),$(".client-preview").css("opacity","1"),$(".client-preview").css("position","absolute"),$(".client-preview .spinner").show(),$(".client-preview .wrap").css("opacity",0),window.location.hash="#client-"+e,$(".order-preview").is(":visible")&&($(".order-preview").css("z-index",2),$(".client-preview").css("z-index",3),$(".order-preview").css("opacity","0"),$(".order-preview").css("position","fixed")),$.template("addressTemplate",'<div class="client-shot-address__line row"> <div class="client-shot-address__name"> <div class="title">пїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅ</div> <p>${NAME}</p> </div> <div class="client-shot-address__street"> <div class="title">пїЅпїЅпїЅпїЅпїЅ</div> <p>${STREET}</p> </div> <div class="client-shot-address__house"> <div class="title">пїЅпїЅпїЅ</div> <p>${HOUSE}</p> </div> <div class="client-shot-address__apartment"> <div class="title">пїЅпїЅ / пїЅпїЅпїЅпїЅ</div> <p>${APARTMENT}</p> </div> </div>'),$.template("orderTemplate",'<div class="orders-history-line"> <div class="orders-history-line__show-card" onclick="viewOrder(${ID});">пїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅ</div> <div class="orders-history-line__about-out"> <div class="orders-history-line__about row"> <div class="orders-history-line__date"> <div class="title">пїЅпїЅпїЅпїЅ</div> <p>${ORDER_DATE}</p> </div> <div class="orders-history-line__order"> <div class="title">пїЅпїЅпїЅпїЅпїЅ</div> <p>${ORDER_CONTENT}</p> </div> <div class="orders-history-line__total"> <div class="title">пїЅпїЅпїЅпїЅпїЅ</div> <p>${ORDER_SUM} <span class="currency">'+window.currency_f+'</span></p> </div> <div class="orders-history-line__status"> <div class="title">пїЅпїЅпїЅпїЅпїЅпїЅ</div> <p>${ORDER_STATUS_NAME}</p> </div> </div> </div> </div>'),$.ajax({url:"/crm/clients/",method:"POST",dataType:"json",data:{action:"getInfo",id:e},success:function(t){if(window.view_user=e,$(".address-list").html(""),t.CHART.columns[0].length>0)var i=c3.generate({grid:{y:{show:!0},x:{show:!0}},legend:{show:!1},tooltip:{contents:function(e,t,i,s){return'<div class="tooltip-text">'+e[0].value+' <span class="currency">'+window.currency_f+"</span></div>"}},bindto:"#chart",data:t.CHART,axis:{x:{type:"timeseries",tick:{outer:!1,values:t.UNIQ_DATES,format:"%d.%m"}}}});$(".favorite-foods-list").html(""),t.TOP_PRODUCTS.length>0?$.each(t.TOP_PRODUCTS,function(e,t){return 5!=e&&void $(".favorite-foods-list").append('<div class="favorite-foods__line row"><div class="favorite-foods__name"><div class="title">пїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅ</div> <p>'+t.name+'</p> </div> <div class="favorite-foods__quantity"> <div class="title">пїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅ</div> <p>'+t.amount+"</p> </div> </div>")}):$(".favorite-foods-list").html("пїЅ пїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅ пїЅпїЅпїЅ пїЅпїЅпїЅпїЅпїЅпїЅпїЅ пїЅпїЅпїЅпїЅ"),t.ADDRESSES.length>0?($(".client-preview .address-list").html(""),$.tmpl("addressTemplate",t.ADDRESSES).appendTo(".address-list")):$(".address-list").text("пїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅ пїЅпїЅ пїЅпїЅпїЅпїЅпїЅпїЅпїЅ пїЅпїЅпїЅпїЅпїЅпїЅпїЅ"),t.ORDERS.length>0?($(".client-preview .orders-list").html(""),$(".orders-statistics").show(),$.tmpl("orderTemplate",t.ORDERS).appendTo(".client-preview .orders-list")):($(".orders-statistics").hide(),$(".client-preview .orders-list").text("пїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅ пїЅпїЅ пїЅпїЅпїЅпїЅпїЅ пїЅпїЅпїЅпїЅпїЅпїЅпїЅ")),1==t.VIP?$(".data-client-info__vip-icon").addClass("active"):$(".data-client-info__vip-icon").removeClass("active"),$(".data-box--registration-source .title").text(t.SOURCE),$(".data-box--latest-order .title").text(t.LAST_ORDER||"пїЅпїЅ пїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅ"),$(".data-box--orders .title").text(t.ORDERS_COUNT),$(".data-box--total-spent .title span").first().text(t.USER_SUM),$(".data-box--spent-bonus .title span").first().text(t.USED_BONUSES),$(".data-client-info__scale .counts .summa span").first().text(t.BONUS_VALUE),$(".sale-scale li").removeClass("active");for(var s=0;s<=parseInt(t.BONUS_LEVEL);s++)$(".sale-scale li:nth-child("+(3-s)+")").addClass("active");void 0==t.NEED_SUM?($(".is-max").show(),$(".not-max").hide()):($(".is-max").hide(),$(".not-max").show(),$(".not-max span").first().text(t.NEED_SUM)),void 0!=t.NAME&&t.NAME.length>0&&$('.client-preview input[name="NAME"]').val(t.NAME).parent().addClass("filled"),void 0!=t.PHONE&&t.PHONE.length>0&&$('.client-preview input[name="PHONE"]').val(t.PHONE).parent().addClass("filled"),void 0!=t.EMAIL&&t.EMAIL.length>0&&$('.client-preview input[name="EMAIL"]').val(t.EMAIL).parent().addClass("filled"),void 0!=t.BIRTHDAY&&t.BIRTHDAY.length>0&&$('.client-preview input[name="BIRTHDAY"]').val(t.BIRTHDAY).parent().addClass("filled"),$('[name="NOTIFY_EMAIL"]').val(t.NOTIFY_EMAIL),$('[name="NOTIFY_SMS"]').val(t.NOTIFY_SMS),1==t.NOTIFY_EMAIL?$('[name="email_notify"]').attr("checked","checked").parent().addClass("checked"):$('[name="email_notify"]').removeAttr("checked").parent().removeClass("checked"),1==t.NOTIFY_SMS?$('[name="sms_notify"]').attr("checked","checked").parent().addClass("checked"):$('[name="sms_notify"]').removeAttr("checked").parent().removeClass("checked"),masking(),$(".client-preview .spinner").hide(),$(".client-preview .wrap").css("opacity",1)}}),!1}function number_format(e,t,i,s){var a,n,d,r,o;return isNaN(t=Math.abs(t))&&(t=2),void 0==i&&(i=","),void 0==s&&(s="."),a=parseInt(e=(+e||0).toFixed(t))+"",d=a.split(/(?=(?:\d{3})+$)/).join(s),r=t?i+Math.abs(e-a).toFixed(t).replace(/-/,0).slice(2):"",d+r}function plural(e,t,i,s){return e=Math.abs(e),e%=100,e>=5&&e<=20?s:(e%=10,1==e?t:e>=2&&e<=4?i:s)}function onlyUnique(e,t,i){return i.indexOf(e)===t}$(document).ready(function(){if($('select[name="PAYMENT_TYPE"]').on("change",function(){"Y"==$(this).find("option:selected").attr("data-change")?$(".short_change").show():$(".short_change").hide()}),$('[name="DELIVERY_TIME"]').mask("99:99",{placeholder:" "}),$(".time_type_toggle").on("click",function(e){return e.preventDefault(),$(".time_config").show(),$(this).hide(),$('[name="DELIVERY_TIME_TYPE"]').val(1),!1}),$('select[name="DISTRICT_ID"]').on("change",function(){calculateOrderSum()}),$(".orders-line__send-mail").each(function(e,t){var i=$(this).closest(".orders-line").attr("data-order"),s=function(e){$("#sms-accept-popover textarea").val(""),$('#sms-accept-popover input[name="ORDER_ID"]').val(i),$('#sms-accept-popover input[name="PHONE"]').val($('.orders-line[data-order="'+i+'"]').attr("data-phone")),$("#sms-accept-popover button").attr("disabled","disabled"),$(".send-state").show(),$(".sent-state").hide(),$(".not-sent-state").hide()};$(t).webuiPopover({id_:$(t).attr("data-id"),url:"#"+$(t).attr("data-id"),cache:!1,onShow:s})}),$("#sms-accept-popover select").on("change",function(){var e=$('.orders-line[data-order="'+$('#sms-accept-popover input[name="ORDER_ID"]').val()+'"]'),t=$(this).find("option:selected").attr("data-template").replace("#NAME#",e.attr("data-username"));t=t.replace("#PHONE#",e.attr("data-phone")),t=t.replace("#ORDER_ID#",e.attr("data-order")),t=t.replace("#SUM#",e.attr("data-sum")),t=t.replace("#ADDRESS#",e.attr("data-address")),t=t.replace("#ORDER_DATE#",e.attr("data-order-date")),t=t.replace("#STATUS#",e.attr("data-status")),$("#sms-accept-popover textarea").val(t),$("#sms-accept-popover button").removeAttr("disabled")}),$("#sms-accept-popover textarea").on("change keyup",function(e){0==$(this).val().length?$("#sms-accept-popover button").attr("disabled","disabled"):$("#sms-accept-popover button").removeAttr("disabled")}),$("#sms-accept-popover button").on("click",function(e){$.ajax({url:"/crm/",method:"POST",dataType:"json",data:{action:"sendSms",PHONE:$('#sms-accept-popover input[name="PHONE"]').val(),TEMPLATE:$("#sms-accept-popover textarea").last().val()},success:function(e){$(".send-state").hide(),1==e.status?($(".sent-state").show(),$("#popover-sms-accept-popover").css("top","310px"),$("#popover-sms-accept-popover .webui-arrow").css("top","20px")):$(".not-sent-state").show()}})}),window.location.hash.indexOf("#order")!==-1){var e=window.location.hash.split("-")[1];viewOrder(e)}if(window.location.hash.indexOf("#client")!==-1){var t=window.location.hash.split("-")[1];viewUser(t)}alertify.set("notifier","position","top-left"),alertify.set("notifier","delay",1),$('.notify-config input[type="checkbox"]').on("change",function(){$(this).is(":checked")?$('[name="'+$(this).data("target")+'"]').val(1):$('[name="'+$(this).data("target")+'"]').val(0)}),$(".save-user-data").on("click",function(){$.ajax({url:"/crm/clients/",method:"post",data:{action:"updateUser",ID:window.view_user,NAME:$('.client-preview input[name="NAME"]').val(),PHONE:$('.client-preview input[name="PHONE"]').val(),EMAIL:$('.client-preview input[name="EMAIL"]').val(),BIRTHDAY:$('.client-preview input[name="BIRTHDAY"]').val(),NOTIFY_EMAIL:$('.client-preview input[name="NOTIFY_EMAIL"]').val(),NOTIFY_SMS:$('.client-preview input[name="NOTIFY_SMS"]').val()},dataType:"json",success:function(e){1==e.status?alertify.success("пїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅ пїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅ"):alertify.error("пїЅпїЅпїЅпїЅпїЅпїЅ пїЅпїЅпїЅ пїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅ пїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅ")}})}),$(".save-order-data").on("click",function(e){e.preventDefault(),$.ajax({url:"/crm/?action=updateOrder",data:$("#order_form").serialize(),method:"post",dataType:"json",success:function(e){1==e.status?alertify.success("пїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅ пїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅ"):alertify.error("пїЅпїЅпїЅпїЅпїЅпїЅ пїЅпїЅпїЅ пїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅ пїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅ")}})}),$(".bd-input input,.bd-input textarea").off("focus").on("focus",function(){if("PHONE"==$(this).attr("name")||"USER[PHONE]"==$(this).attr("name")||"ORDER[USER_PHONE]"==$(this).attr("name")){var e=$(this).val()||"+7";$(this).val(e)}var t=$(this).parents(".bd-input");t.addClass("focused").removeClass("error ok"),t.removeClass("filled"),t.closest(".input-row")&&t.closest(".input-row").css("margin-top",0),t.closest(".input-row-last")&&t.closest(".input-row-last").css("margin-top",0)}),$(".bd-input input,.bd-input textarea").off("blur").on("blur",function(){var e=$(this).parents(".bd-input");e.removeClass("focused"),$(this).val().trim().length>0?e.addClass("filled"):e.removeClass("filled")}),$(".close-window").on("click",function(){$(this).closest('[class*="-preview"]').hide();var e=0;$(".order-preview").is(":visible")&&(window.location.hash="#order-"+$(".order-preview .order_num_value").text(),$(".order-preview").css("opacity","1"),$(".order-preview").css("position","absolute"),e=1),$(".client-preview").is(":visible")&&(window.location.hash="#client-"+$(".customer-information__client-head .num a").text(),$(".client-preview").css("opacity","1"),$(".client-preview").css("position","absolute"),e=1),e||(window.location.hash="",$(".wrapper").first().css("opacity",1))}),$('input[type="checkbox"]').length&&$('input[type="checkbox"]').uniform(),$(".basic").selectOrDie(),$(".delivery-select").on("click",".delivery-select__item:not(.active)",function(){
$('[name="DELIVERY_TYPE"]').val($(this).attr("data-type")),$(this).addClass("active").siblings().removeClass("active"),$(this).closest(".customer-information__delivery").find(".delivery-options").removeClass("active").eq($(this).index()).addClass("active")}),$(".data-client-info__vip-icon").on("click",function(){$.ajax({url:"/crm/clients/",method:"POST",dataType:"json",data:{action:"setVip",id:window.view_user},success:function(e){1==e.status?$(".data-client-info__vip-icon").addClass("active"):$(".data-client-info__vip-icon").removeClass("active")}})}),$(".date-filter input").on("change",function(){$('.date-filter input[name="date_start"]').val().length>0&&$('.date-filter input[name="date_end"]').val().length>0?$(".date-filter .apply-filter").removeAttr("disabled").removeClass("disabled"):$(".date-filter .apply-filter").attr("disabled","disabled").addClass("disabled")})});var dateFormat=function(){var e=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,t=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,i=/[^-+\dA-Z]/g,s=function(e,t){for(e=String(e),t=t||2;e.length<t;)e="0"+e;return e};return function(a,n,d){var r=dateFormat;if(1!=arguments.length||"[object String]"!=Object.prototype.toString.call(a)||/\d/.test(a)||(n=a,a=void 0),a=a?new Date(parseInt(a)):new Date,isNaN(a))throw SyntaxError("invalid date");n=String(r.masks[n]||n||r.masks.default),"UTC:"==n.slice(0,4)&&(n=n.slice(4),d=!0);var o=d?"getUTC":"get",l=a[o+"Date"](),c=a[o+"Day"](),p=a[o+"Month"](),_=a[o+"FullYear"](),v=a[o+"Hours"](),u=a[o+"Minutes"](),m=a[o+"Seconds"](),E=a[o+"Milliseconds"](),T=d?0:a.getTimezoneOffset(),h={d:l,dd:s(l),ddd:r.i18n.dayNames[c],dddd:r.i18n.dayNames[c+7],m:p+1,mm:s(p+1),mmm:r.i18n.monthNames[p],mmmm:r.i18n.monthNames[p+12],yy:String(_).slice(2),yyyy:_,h:v%12||12,hh:s(v%12||12),H:v,HH:s(v),M:u,MM:s(u),s:m,ss:s(m),l:s(E,3),L:s(E>99?Math.round(E/10):E),t:v<12?"a":"p",tt:v<12?"am":"pm",T:v<12?"A":"P",TT:v<12?"AM":"PM",Z:d?"UTC":(String(a).match(t)||[""]).pop().replace(i,""),o:(T>0?"-":"+")+s(100*Math.floor(Math.abs(T)/60)+Math.abs(T)%60,4),S:["th","st","nd","rd"][l%10>3?0:(l%100-l%10!=10)*l%10]};return n.replace(e,function(e){return e in h?h[e]:e.slice(1,e.length-1)})}}();dateFormat.masks={default:"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"},dateFormat.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]},Date.prototype.format=function(e,t){return dateFormat(this,e,t)};